clear;clc;close all;
RT = 1;
g = 9.80665;
L1 = 2.2;
L2 = 1.7;
m1 = 1.2; m2 = 1.7;
m1_2 = 1.3; m2_2 = 1.8;
m1_3 = 1.4; m2_3 = 1.6;
theta10 = 100; theta20 = -10;
theta10 = theta10*pi/180;theta20 = theta20*pi/180;
OM10 = -30;OM20 = 20;
OM10=OM10*pi/180;OM20=OM20*pi/180;
omega1 = sqrt(g/L1);omega2 = sqrt(g/L2);
T1 = 2 * pi/omega1; T2 = 2 * pi * omega2;
T = max(T1,T2);
ti = 0;tf = 5 * T;N = 200000; t = linspace(ti,tf,N); dt = t(2) - t(1);
theta1 = zeros(1,N); theta2 = theta1;
theta1_2 = zeros(1,N); theta2_2 = theta1;
theta1_3 = zeros(1,N); theta2_3 = theta1;
OM1 = zeros(1,N);
OM2 = OM1;
OM1_2 = zeros(1,N);
OM2_2 = OM1_2;
OM1_3 = zeros(1,N);
OM2_3 = OM1_3;
theta1(1) = theta10; theta2(1) = theta20;
theta1_2(1) = theta10; theta2_2(1) = theta20;
theta1_3(1) = theta10; theta2_3(1) = theta20;
theta1(2) = theta10 + OM10 * dt;theta2(2) = theta20 + OM20 * dt;
theta1_2(2) = theta10 + OM10 * dt;theta2_2(2) = theta20 + OM20 * dt;
theta1_3(2) = theta10 + OM10 * dt;theta2_3(2) = theta20 + OM20 * dt;
OM1(1) = OM10; OM2(1) = OM20;
OM1_2(1) = OM10; OM2_2(1) = OM20;
OM1_3(1) = OM10; OM2_3(1) = OM20;
miu = 1 + m1/m2;
miu_2 = 1 + m1_2/m2_2;
miu_3 = 1 + m1_3/m2_3;
r = L2/L1;
a11 = miu; a22 = r;
a11_2 = miu_2;
a11_3 = miu_3;
tic;
for i = 2:N-1
    aux=theta2(i)-theta1(i);
    aux_2=theta2_2(i)-theta1_2(i);
    aux_3=theta2_3(i)-theta1_3(i);
    a21=cos(aux);a12 = a21 * r;
    a21_2=cos(aux_2);a12_2 = a21_2 * r;
    a21_3=cos(aux_3);a12_3 = a21_3 * r;
    OM1(i) = (theta1(i) - theta1(i - 1))/ dt;
    OM2(i) = (theta2(i) - theta2(i - 1))/ dt;
    OM1_2(i) = (theta1_2(i) - theta1_2(i - 1))/ dt;
    OM2_2(i) = (theta2_2(i) - theta2_2(i - 1))/ dt;
    OM1_3(i) = (theta1_3(i) - theta1_3(i - 1))/ dt;
    OM2_3(i) = (theta2_3(i) - theta2_3(i - 1))/ dt;
    b1 = r * OM2(i)^2*sin(aux) - g / L1*miu*sin(theta1(i));
    b1_2 = r * OM2_2(i)^2*sin(aux_2) - g / L1*miu_2*sin(theta1_2(i));
    b1_3 = r * OM2_3(i)^2*sin(aux_3) - g / L1*miu_3*sin(theta1_3(i));
    b2_2 = -OM1_2(i)^2*sin(aux_2) - g/L1*sin(theta2_2(i));
    b2 = -OM1(i)^2*sin(aux) - g/L1*sin(theta2(i));
    b2_3 = -OM1_3(i)^2*sin(aux_3) - g/L1*sin(theta2_3(i));
    A = [a11,a12;a21,a22];
    A_2 = [a11_2,a12_2;a21_2,a22];
    A_3 = [a11_3,a12_3;a21_3,a22];
    B = [b1;b2];
    B_2 = [b1_2;b2_2];
    B_3 = [b1_3;b2_3];
    E = A\B;
    E_2 = A_2\B_2;
    E_3 = A_3\B_3;
    eps1 = E(1);eps2 = E(2);
    eps1_2 = E_2(1);eps2_2 = E_2(2);
    eps1_3 = E_3(1);eps2_3 = E_3(2);
    theta1(i + 1)= 2 * theta1(i)-theta1(i - 1)+dt^2*eps1;
    theta2(i + 1)= 2 * theta2(i)-theta2(i - 1)+dt^2*eps2;
    %
    theta1_2(i + 1)= 2 * theta1_2(i)-theta1_2(i - 1)+dt^2*eps1_2;
    theta2_2(i + 1)= 2 * theta2_2(i)-theta2_2(i - 1)+dt^2*eps2_2;
    theta1_3(i + 1)= 2 * theta1_3(i)-theta1_3(i - 1)+dt^2*eps1_3;
    theta2_3(i + 1)= 2 * theta2_3(i)-theta2_3(i - 1)+dt^2*eps2_3;
end
OM1(N) = (theta1(N) - theta1(N - 1))/ dt;
OM2(N) = (theta2(N) - theta2(N - 1))/ dt;
OM1_2(N) = (theta1_2(N) - theta1_2(N - 1))/ dt;
OM2_2(N) = (theta2_2(N) - theta2_2(N - 1))/ dt;
OM1_3(N) = (theta1_3(N) - theta1_3(N - 1))/ dt;
OM2_3(N) = (theta2_3(N) - theta2_3(N - 1))/ dt;
toc;
x1 = L1*sin(theta1);x2 = x1 + L2 * sin(theta2);
y1 = -L1*cos(theta1);y2 = y1 - L2 * cos(theta2);
x1_2 = L1*sin(theta1_2);x2_2 = x1_2 + L2 * sin(theta2_2);
y1_2 = -L1*cos(theta1_2);y2_2 = y1_2 - L2 * cos(theta2_2);
x1_3 = L1*sin(theta1_3);x2_3 = x1_3 + L2 * sin(theta2_3);
y1_3 = -L1*cos(theta1_3);y2_3 = y1_3 - L2 * cos(theta2_3);
T = 1/2 * (m1*L1^2*OM1.^2+m2*(L1^2*OM1.^2+L2^2*OM2.^2+2*L1*L2*OM1.*OM2.*cos(theta2-theta1)));
U = -g*((m1 + m2) * L1*cos(theta1) + m2*L2*cos(theta2));
H = T + U;
figure(1);
Lmax = L1 + L2;
coef = 30;
rg1 = coef*m1^(1/3);rg2 = coef*m2^(1/3);
rg1_2 = coef*m1_2^(1/3);rg2_2 = coef*m2_2^(1/3);
rg1_3 = coef*m1_3^(1/3);rg2_3 = coef*m2_3^(1/3);
tic;simt = 0;
while simt<tf
    j = abs(t - simt) == min(abs(t - simt));
    plot([0,x1(j) x2(j)], [0, y1(j), y2(j)], '-g','LineWidth',3); hold on;
    plot([0,x1_2(j) x2_2(j)], [0, y1_2(j), y2_2(j)], '-c','LineWidth',3); hold on;
    plot([0,x1_3(j) x2_3(j)], [0, y1_3(j), y2_3(j)], '-m','LineWidth',3); hold on;
    xlabel('x/m');ylabel('y/m');
    plot(0,0,'.k','MarkerSize',10);
    plot(x1(j),y1(j),'.r','MarkerSize',rg1);
    plot(x1_2(j),y1_2(j),'.r','MarkerSize',rg1);
    plot(x1_3(j),y1_3(j),'.r','MarkerSize',rg1);
    plot(x2(j),y2(j),'.b','MarkerSize',rg2);
    plot(x2_2(j),y2_2(j),'.b','MarkerSize',rg2);
    plot(x2_3(j),y2_3(j),'.b','MarkerSize',rg2);
    axis([-Lmax Lmax -Lmax Lmax]); axis square;
    %text(3/5*Lmax,3/5*Lmax,['E = ',num2str(round(H(j))),'J']);
    if RT == 1
        simt = toc;
        text(4/5*Lmax,4/5*Lmax,['t = ',num2str(round(t(j))),'s']);
    else
        simt = simt + 10^-2;
        text(3/5*Lmax,4/5*Lmax,['t = ',num2str(round(t(j) * 100)),'cs']);
    end
    pause(1e-6);hold off;
end